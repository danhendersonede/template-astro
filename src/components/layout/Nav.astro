---
import { siteConfig } from '@/config/site';

export interface Props {
  activePathname?: string;
  showLogo?: boolean;
  variant?: 'default' | 'minimal';
}

const {
  activePathname = Astro.url.pathname,
  showLogo = true,
  variant = 'default',
} = Astro.props;

const normalizedPath = activePathname.endsWith('/')
  ? activePathname.slice(0, -1)
  : activePathname;

const isActive = (href: string) => {
  const normalizedHref = href.endsWith('/') ? href.slice(0, -1) : href;
  if (normalizedHref === '') return normalizedPath === '';
  return normalizedPath === normalizedHref;
};
---

<nav aria-label="Main navigation" class:list={['nav', variant]}>
  <div class="nav-container">
    {
      showLogo && (
        <a href="/" class="nav-logo" aria-label="Home">
          {siteConfig.name}
        </a>
      )
    }

    <!-- Desktop menu -->
    <ul class="nav-menu nav-menu-desktop">
      {
        siteConfig.nav.map(item => (
          <li class="nav-item">
            <a
              href={item.href}
              class:list={['nav-link', { active: isActive(item.href) }]}
              aria-current={isActive(item.href) ? 'page' : undefined}
            >
              {item.label}
            </a>
          </li>
        ))
      }
    </ul>

    <!-- Mobile menu toggle -->
    <button
      class="nav-toggle"
      aria-label="Open navigation menu"
      data-nav-toggle
    >
      <span class="nav-toggle-icon"></span>
    </button>
  </div>
</nav>

<!-- Mobile menu dialog -->
<dialog class="nav-dialog" id="nav-dialog" aria-label="Navigation menu">
  <div class="nav-dialog-header">
    <div class="nav-dialog-spacer"></div>
    <button class="nav-dialog-close" aria-label="Close navigation menu">
      <span class="nav-dialog-close-icon"></span>
    </button>
  </div>
  <ul class="nav-menu nav-menu-mobile">
    {
      siteConfig.nav.map(item => (
        <li class="nav-item">
          <a
            href={item.href}
            class:list={['nav-link', { active: isActive(item.href) }]}
            aria-current={isActive(item.href) ? 'page' : undefined}
          >
            {item.label}
          </a>
        </li>
      ))
    }
  </ul>
</dialog>

<script>
  // Progressive enhancement for mobile menu with HTML Dialog
  const dialog = document.getElementById('nav-dialog') as HTMLDialogElement;
  const navToggle = document.querySelector('[data-nav-toggle]');
  const closeButton = document.querySelector('.nav-dialog-close');
  const navLinks = dialog?.querySelectorAll('.nav-link');

  function openMenu() {
    if (!dialog) return;
    dialog.showModal();
  }

  function closeMenu() {
    if (!dialog) return;
    dialog.close();
  }

  // Open dialog on toggle click
  navToggle?.addEventListener('click', openMenu);

  // Close dialog on close button click
  closeButton?.addEventListener('click', closeMenu);

  // Close dialog when clicking backdrop (outside dialog content)
  dialog?.addEventListener('click', e => {
    const rect = dialog.getBoundingClientRect();
    const isInDialog =
      rect.top <= e.clientY &&
      e.clientY <= rect.top + rect.height &&
      rect.left <= e.clientX &&
      e.clientX <= rect.left + rect.width;

    if (!isInDialog) {
      closeMenu();
    }
  });

  // Close dialog when clicking a nav link
  navLinks?.forEach(link => {
    link.addEventListener('click', closeMenu);
  });

  // Dialog handles Escape key and focus trap automatically!
</script>

<style>
  .nav {
    background-color: #ffffff;
    border-block-end: 1px solid #e5e7eb;
    position: sticky;
    inset-block-start: 0;
    z-index: 100;
  }

  .nav-container {
    max-inline-size: 1200px;
    margin-inline: auto;
    padding-block: clamp(0.75rem, 2vw, 1rem);
    padding-inline: clamp(1rem, 4vw, 2rem);
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: clamp(1rem, 3vw, 2rem);
  }

  .nav-logo {
    font-size: clamp(1.125rem, 2vw + 0.5rem, 1.25rem);
    font-weight: 700;
    color: #111827;
    text-decoration: none;
  }

  @media (prefers-reduced-motion: no-preference) {
    .nav-logo {
      transition: color 0.2s;
    }
  }

  .nav-logo:hover,
  .nav-logo:focus {
    color: #4f46e5;
  }

  .nav-toggle {
    display: none;
    background: none;
    border: none;
    cursor: pointer;
    padding-block: 0.5rem;
    padding-inline: 0.5rem;
    position: relative;
    inline-size: 40px;
    block-size: 40px;
  }

  .nav-toggle-icon,
  .nav-toggle-icon::before,
  .nav-toggle-icon::after {
    display: block;
    inline-size: 24px;
    block-size: 2px;
    background-color: #111827;
    position: absolute;
    inset-inline-start: 50%;
    transform: translateX(-50%);
  }

  .nav-toggle-icon {
    inset-block-start: 50%;
    transform: translate(-50%, -50%);
  }

  .nav-toggle-icon::before,
  .nav-toggle-icon::after {
    content: '';
  }

  .nav-toggle-icon::before {
    inset-block-start: -8px;
  }

  .nav-toggle-icon::after {
    inset-block-start: 8px;
  }

  .nav-menu {
    display: flex;
    list-style: none;
    margin: 0;
    padding: 0;
    gap: clamp(0.25rem, 1vw, 0.5rem);
    align-items: center;
    flex: 1;
    justify-content: flex-end;
  }

  .nav-menu-mobile {
    display: none;
  }

  .nav-item {
    margin: 0;
  }

  .nav-link {
    display: block;
    padding-block: 0.5rem;
    padding-inline: clamp(0.75rem, 2vw, 1rem);
    color: #4b5563;
    text-decoration: none;
    font-weight: 500;
    font-size: clamp(0.875rem, 1.5vw + 0.5rem, 1rem);
    border-radius: 0.375rem;
    position: relative;
    white-space: nowrap;
  }

  @media (prefers-reduced-motion: no-preference) {
    .nav-link {
      transition: all 0.2s;
    }
  }

  .nav-link:hover,
  .nav-link:focus {
    color: #4f46e5;
    background-color: #f3f4f6;
  }

  .nav-link.active {
    color: #4f46e5;
    background-color: #eef2ff;
  }

  /* Minimal variant */
  .nav.minimal {
    background-color: transparent;
    border-block-end: none;
  }

  /* Dialog (mobile menu) */
  .nav-dialog {
    border: none;
    padding: 0;
    inline-size: 100%;
    max-inline-size: 100%;
    block-size: 100dvh;
    max-block-size: 100dvh;
    margin: 0;
    inset: 0;
    background-color: #ffffff;
    overflow-x: hidden;
    overflow-y: auto;
    overscroll-behavior: contain;
  }

  @media (prefers-reduced-motion: no-preference) {
    .nav-dialog {
      animation: fadeIn 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
    }
    to {
      opacity: 1;
    }
  }

  .nav-dialog::backdrop {
    background-color: rgba(0, 0, 0, 0.8);
  }

  @media (prefers-reduced-motion: no-preference) {
    .nav-dialog::backdrop {
      animation: backdropFadeIn 0.2s;
    }
  }

  @keyframes backdropFadeIn {
    from {
      opacity: 0;
    }
    to {
      opacity: 1;
    }
  }

  .nav-dialog-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-block: clamp(0.75rem, 2vw, 1rem);
    padding-inline: clamp(1rem, 4vw, 2rem);
    border-block-end: 1px solid #e5e7eb;
  }

  .nav-dialog-spacer {
    /* Matches the logo space to keep close button aligned to the right */
    inline-size: auto;
  }

  .nav-dialog-close {
    background: none;
    border: none;
    cursor: pointer;
    padding-block: 0.5rem;
    padding-inline: 0.5rem;
    inline-size: 40px;
    block-size: 40px;
    position: relative;
    border-radius: 0.375rem;
  }

  @media (prefers-reduced-motion: no-preference) {
    .nav-dialog-close {
      transition: background-color 0.2s;
    }
  }

  .nav-dialog-close:hover,
  .nav-dialog-close:focus {
    background-color: #f3f4f6;
  }

  .nav-dialog-close-icon,
  .nav-dialog-close-icon::before {
    display: block;
    inline-size: 24px;
    block-size: 2px;
    background-color: #111827;
    position: absolute;
    inset-inline-start: 50%;
    inset-block-start: 50%;
  }

  .nav-dialog-close-icon {
    transform: translate(-50%, -50%) rotate(45deg);
  }

  .nav-dialog-close-icon::before {
    content: '';
    transform: translate(-50%, -50%) rotate(90deg);
  }

  .nav-menu-mobile {
    display: flex;
    flex-direction: column;
    padding-block: clamp(1.5rem, 3vh, 2rem);
    padding-inline: clamp(1rem, 4vw, 2rem);
    gap: 0.5rem;
    align-items: stretch;
    justify-content: flex-start;
  }

  .nav-menu-mobile .nav-item {
    inline-size: 100%;
    max-inline-size: 100%;
  }

  .nav-menu-mobile .nav-link {
    display: block;
    padding-block: clamp(1rem, 3vh, 1.25rem);
    padding-inline: clamp(1rem, 3vw, 1.5rem);
    border-radius: 0.5rem;
    border-block-end: none;
    font-size: clamp(1rem, 2.5vw + 0.5rem, 1.25rem);
    text-align: center;
  }

  .nav-menu-mobile .nav-link:hover,
  .nav-menu-mobile .nav-link:focus {
    background-color: #f3f4f6;
  }

  .nav-menu-mobile .nav-link.active {
    background-color: #eef2ff;
  }

  /* Mobile/tablet - content-driven breakpoint */
  @media (max-width: 48rem) {
    .nav-toggle {
      display: block;
    }

    .nav-menu-desktop {
      display: none;
    }
  }
</style>
